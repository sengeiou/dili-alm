<#body>
<style>
.window-shadow {
	display: none
}
</style>
<%if(project!null!=null){%>
<div id="cusTools">
	<a onclick="<%if(backUrl!'' == ''){%>window.history.go(-1);<%}else{%>window.location.href='${backUrl!}';<%}%>" class="easyui-linkbutton"
		style="width: 50px; height: 24px; text-align: center; text-decoration: none; color: #000; border: 1px solid #ccc; border-radius: 3px; background: #ecf2ef; padding: 5px; float: right;">返回</a>
</div>
<%}%>
<div class="easyui-layout" fit="true" style="">
	<div id="smDialog" style="display: none;"></div>
	<!-- ====================================================================================================================== -->
	<!-- 上方布局 -->
	<!-- ====================================================================================================================== -->
	<div region="north" height="auto" align="center">
		<!-- =========================================================表单========================================================= -->
		<div class="easyui-panel" style="width: 100%;" align="left">
			<form id="form" class="easyui-form" method="post" fit="true">
				<table style="padding: 10px;">
					<%if(taskId!null!=null){%>
					<input type="hidden" id="taskId" name="id" value="${taskId}"> <%}%>
					<tr>
						<td style="padding: 5px;"><input class="easyui-textbox" name="name" id="name" style="width: 100%"
							data-options="label:'任务名称:', validType:'length[0,255]'" /></td>
						<td style="padding: 5px;"><input class="easyui-textbox" name="projectId" id="projectId" style="width: 100%"
							data-options="label:'所属项目:'" /> <#comboProvider _id="projectId" _table="project" _valueField="id" _textField="name" />
							
				<td style="padding: 5px; display: none;"><input name="versionId" id="versionId" class="easyui-combobox" style="width: 100%;"
								data-options="label:'所属版本:'" /></td>
							<tr>
								<td style="padding:5px; display:none;">
                            <input name="phaseName" id="phaseName" class="easyui-combobox" style="width: 100%;" panelWidth="auto"
									panelHeight="auto" editable="false" data-options="label:'所属阶段:'">
                            <#comboProvider _id="phaseName" _table="data_dictionary_value" _valueField="value" _textField="code"
										_orderByClause="order_number asc" _queryParams='{"yn":1,"dd_id":10}' />
                        </td>
                        <td style="padding:5px;">
                            <input name="owner" id="owner" class="easyui-textbox" style="width:100%;"
									data-options="label:'责任人:',buttonText:'选择',
									onClickButton:selectMember,onChange:_changeTextboxShowClear">
                        </td>
                        <td style="padding:5px;">
                            <input name="status" id="status" class="easyui-combobox" style="width: 100%;" panelWidth="auto"
									panelHeight="auto" editable="false" data-options="label:'状态:'">
                            <#comboProvider _id="status" _table="data_dictionary_value" _valueField="value" _textField="code"
										_orderByClause="order_number asc" _queryParams='{"yn":1,"dd_id":16}' />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <a href="#" class="easyui-linkbutton" iconCls="icon-search" id="queryBtn" onclick="queryGrid(1)">查询</a>
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-reload" onclick="clearForm()">重置</a>
                        </td>
                    </tr>
                
				
				
				
				</table>
			</form>
		</div>
	</div>
	<!-- ====================================================================================================================== -->
	<!-- 中央布局 -->
	<!-- ====================================================================================================================== -->
	<!-- 表格 -->
	<div region="center" style="width: 100%;" height="auto">
		<!-- =========================================================表格========================================================= -->
		<table class="easyui-datagrid" title="任务列表" id="grid" fitColumns="true" pagination="true" pageSize="30" pageNumber="1" pagePosition="both"
			rownumbers="true" remoteSort="false" loadMsg="数据加载中..." singleSelect="true" method="post" multiSort="false" align="center" fit="true"
			striped="true" toolbar="#toolbar" idField="id" data-options="onDblClickRow:openUpdate, onHeaderContextMenu:headerContextMenu">
			<thead>
				<tr>
					<th data-options="field:'name',width:'12%',formatter:formatNameOptions,fixed:'false'">任务名称</th>
					<th data-options="field:'projectId',width:'12%',fixed:'false',_provider:'projectProvider'">项目名称</th>
					<th data-options="field:'versionId',width:'10%',fixed:'false',_provider:'projectVersionProvider'">所属版本</th>
					<th data-options="field:'phaseId',width:'10%',fixed:'false',_provider:'projectPhaseProvider'">所属阶段</th>
					<th data-options="field:'owner',width:'6%',align:'center', fixed:'false',_provider:'memberProvider'">责任人</th>
					<th data-options="field:'planDays',width:'16%',align:'center', resizable:'true', fixed:'false'">计划工时</th>
					<th data-options="field:'status',width:'5%', align:'center',  fixed:'false',_provider:'taskStateProvider'">状态</th>
					<th data-options="field:'progress',formatter:progressFormatter,fixed:'false'">进度</th>
					<th data-options="field:'flowStr',width:'6%', align:'center', fixed:'false'">流程</th>
					<th data-options="field:'options', width:'13%',formatter:formatOptions, align:'center', resizable:'true', fixed:'false'">操作</th>
				</tr>
			</thead>
		</table>
		<!-- datagrid工具栏 -->
		<div id="toolbar" style="height: 20px; padding: 2px 5px;">
			<span id="manager_tools"> <#resource code="addTask"> <a
					href="#" class="easyui-linkbutton" iconCls="icon-add" onclick="openInsert()" plain="true"></a> </#resource> <#resource code="updateTask">
				<a href="#" class="easyui-linkbutton" iconCls="icon-edit" onclick="openUpdate()" plain="true"></a> </#resource> <#resource code="delTask">
				<a href="#" class="easyui-linkbutton" iconCls="icon-remove" onclick="del()" plain="true"></a> </#resource>
			</span>
			<div style="float: right">
				边框显示: <select onchange="changeBorder('grid',this.value)">
					<option value="lines-both">全边框</option>
					<option value="lines-no">无边框</option>
					<option value="lines-right">右边框</option>
					<option value="lines-bottom">下边框</option>
				</select> 行条纹: <input type="checkbox" checked="checked" onclick="$('#grid').datagrid({striped:$(this).is(':checked')})">
			</div>
		</div>
	</div>
</div>
<!-- 隐藏编辑框 -->
<div id="dlg" class="easyui-dialog" resizable="false" constrain="true" shadow="false" draggable="false" title="任务信息"
	style="padding: 0px 20px 10px;" modal="true" border="thin" closed="true"
	data-options="
                iconCls: 'icon-save',
                ">
	<form id="_form" class="easyui-form" method="post" fit="true">
		<input name="_id" id="_id" type="hidden">
		<table width="560px" height="auto">
			<tr>
				<td style="padding: 5px; width: 50%;"><input class="easyui-textbox" name="_name" id="_name" style="width: 100%"
					data-options="label:'任务名称:', required:true,validType:'length[0,255]',prompt:'请填写任务名称'" /></td>
				<td style="padding: 5px; width: 50%;"><input name="_projectId" id="_projectId" class="easyui-combobox" style="width: 100%;"
					editable="false" data-options="label:'所属项目:', required:true,validType:'isIds',prompt:'--选择所属项目--'"></td>
			</tr>
			<tr>
				<td style="padding: 5px;"><input name="_versionId" id="_versionId" class="easyui-combobox" style="width: 100%;" editable="false"
					data-options="label:'所属版本:', required:true,validType:'isIds',prompt:'--选择所属版本--'"></td>
				<td style="padding: 5px;"><input name="_phaseId" id="_phaseId" class="easyui-combobox" style="width: 100%;" editable="false"
					data-options="label:'所属阶段:', required:true,validType:'isIds',prompt:'--选择所属阶段--'"></td>
			</tr>
			<tr>
				<td style="padding: 5px;"><input class="easyui-datebox" name="startDateShow" id="startDateShow" editable="false"
					style="width: 100%" data-options="label:'开始时间:', required:true,validType:'isIds',prompt:'任务开始时间不能早于项目开始时间'" /></td>
				<td style="padding: 5px;"><input class="easyui-datebox" name="endDateShow" id="endDateShow" editable="false" style="width: 100%"
					data-options="label:'结束时间:', required:true,validType:'endDateValidate[\'startDateShow\']',prompt:'任务结束时间不能晚于项目结束时间'" /></td>
			</tr>
			<tr>
				<td style="padding: 5px;"><input name="_beforeTask" id="_beforeTask" class="easyui-combobox" style="width: 100%;" editable=false
					data-options="label:'前置任务:',editable:false"></td>
				<td style="padding: 5px;"><input name="_type" id="_type" class="easyui-combobox" style="width: 100%;" editable=false
					panelWidth="auto" panelHeight="auto" data-options="label:'任务类型:', required:true,validType:'isIds',prompt:'--任务类型选择--'"> <#comboProvider
						_id="_type" _table="data_dictionary_value" _valueField="value" _textField="code" _orderByClause="order_number asc"
						_queryParams='{"yn":1,"dd_id":17}' /></td>
			</tr>
			<tr>
				<td style="padding: 5px;"><input name="_owner" id="_owner" class="easyui-combobox" style="width: 100%"
					data-options="label:'责任人:', required:true,validType:'isIds',prompt:'--请先选择项目--'"></td>
				<td style="padding: 5px;"><input class="easyui-numberbox" name="planTimeStr" id="planTimeStr" style="width: 100%" min="0"
					data-options="label:'计划工时:',validType:['length[0,5]'], required:true,prompt:'填写数字类型'" /></td>
			</tr>
			<tr>
				<td style="padding: 5px;"><select name="flowSt" id="flowSt" class="easyui-combobox" editable=false
					data-options="label:'流程:', required:true" style="width: 100%">
						<option value=1>正常流程</option>
						<option value=0>变更流程</option>
				</select></td>
				<td style="padding: 5px;">
					<div id="changeIdTr">
						<input name="_changeId" id="_changeId" class="easyui-combobox" style="width: 265px" data-options="label:'变更项目:'">
					</div>
				</td>
			</tr>
			<tr>
				<td style="padding: 5px;" colspan="2"><input class="easyui-textbox" name="_describe" id="_describe"
					style="width: 100%; height: 50px;" data-options="label:'描述:', validType:'length[0,255]'" /></td>
			</tr>
		</table>
	</form>
	<!-- 隐藏工时信息 -->
	<div id="task_detail" style="display: none;">
		<hr>
		<h3 style="margin: 15px 0 5px">工时任务信息</h3>
		<form name="detail_form" id="detail_form">
			<input name="taskId" id="taskId" type="hidden"> <input name="taskHour" id="taskHour" type="hidden">
			<table width="550px;" style="border: 1px; padding: 5px 5px 15px 5px;">
				<tr>
					<td style="padding: 5px; width: 50%"><input class="easyui-datebox" name="modified" id="modified" editable="false"
						style="width: 100%; height: 26px;" editable="false" data-options="label:'任务日期:', required:true,validType:'checkDate'" /></td>
					<td style="padding: 0 5px; width: 50%"><label style="float: left; width: 30%;">任务进度:</label>
						<div id="_progressShow" style="width: 170px;"></div></td>

				</tr>
				<tr>
					<td style="padding: 5px;"><input class="easyui-numberbox" name="taskHourStr" id="taskHourStr" style="width: 100%; height: 26px;"
						data-options="label:'任务工时:',validType:'taskHours[\'overHourStr\']'" /></td>
					<td style="padding: 5px;"><input class="easyui-numberbox" name="_taskHour" id="_taskHour" style="width: 100%; height: 26px;"
						data-options="label:'已填工时:',disabled:true" /></td>
				</tr>
				<tr>
					<td style="padding: 5px;"><input class="easyui-numberbox" name="overHourStr" id="overHourStr" style="width: 100%; height: 26px;"
						data-options="label:'加班工时:',validType:'overHours[\'taskHourStr\']'" /></td>
					<td style="padding: 5px;"><input class="easyui-numberbox" name="_overHour" id="_overHour" style="width: 100%; height: 26px;"
						data-options="label:'已填加班:',disabled:true" /></td>
				</tr>
				<tr>
					<td style="padding: 5px;" colspan="2"><input class="easyui-textbox" name="describe" id="describe" style="width: 100%;"
						data-options="label:'工作内容描述:', validType:'length[0,255]',multiline:true, required:true" /></td>
				</tr>
			</table>
		</form>
	</div>
	<!-- 隐藏工时信息详情 -->
	<div id="task_detail_list" style="display: none; width: 550px; padding: 5px 5px 10px 5px;">
		<hr>
		<h3>
			工时任务信息 &nbsp;&nbsp;&nbsp; <span style="font-weight: lighter; font-size: 12px">已填写 : &nbsp;加班工时&nbsp;<a style="font-weight: bold;"
				id="showOverFont">6</a>&nbsp;H,常规工时&nbsp;<a style="font-weight: bold" id="showTaskFont">6</a>&nbsp;H。
			</span>
		</h3>
		<table class="easyui-datagrid" style="height: 160px" id="detail_grid" loadMsg="数据加载中..." idField="id">
			<thead>
				<tr>
					<th data-options="field:'taskHour',width:'10%',fixed:'false'">工时</th>
					<th data-options="field:'overHour',width:'10%',fixed:'false'">加班</th>
					<th data-options="field:'owner',width:'10%',fixed:'false',formatter:ownerFormatter">责任人</th>
					<th data-options="field:'created',width:'20%', _provider:'datetimeProvider',nowarp:false">填写时间</th>
					<th data-options="field:'modified',width:'20%', _provider:'datetimeProvider',nowarp:false">任务日</th>
					<th data-options="field:'describe',width:'30%',fixed:'true',formatter:describeFormatter">工作内容描述</th>
				</tr>
			</thead>
		</table>
	</div>
	<div id="dialog_toolbar" style="display: show; background-color: #fff; width: 100%;">
		<a href="#" id="saveTask" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true" onclick="saveOrUpdate()"
			style="border: 1px solid #ccc;">保存</a> <a href="#" class="easyui-linkbutton" data-options="plain:true"
			onclick="$('#dlg').dialog('close');" style="border: 1px solid #ccc;">取消</a>
	</div>
	<div id="dialog_toolbar_detail" style="display: none; background-color: #fff; width: 100%;">
		<a href="#" id="doTask" class="easyui-linkbutton" data-options="iconCls:'icon-edit',plain:true" style="border: 1px solid #ccc;"
			onclick="startTask()">开始执行任务</a> <a href="#" id="pauseTask" class="easyui-linkbutton" data-options="plain:true"
			style="border: 1px solid #ccc;" onclick="pauseTaskStatus()"> 暂停任务</a> <a href="#" id="complate" class="easyui-linkbutton"
			data-options="plain:true" style="border: 1px solid #ccc;" onclick="complate()">完成任务</a> <a href="#" id="updateDetail"
			class="easyui-linkbutton" data-options="plain:true" style="border: 1px solid #ccc;" onclick="saveTaskDetail()">提交工时</a> <a href="#"
			class="easyui-linkbutton" data-options="plain:true" onclick="$('#dlg').dialog('close');" style="border: 1px solid #ccc;">取消</a>
	</div>
</div>
<!-- ====================================================================================================================== --> <!-- style & script 分隔线 -->
<!-- ====================================================================================================================== --> <script
	type="text/javascript">
    //打开新增窗口
    function openInsert() {
        canEdit();
        //defaultValue();
        $("#task_detail").hide();
        $("#dialog_toolbar").show();
        $("#dialog_toolbar_detail").hide();
        $("#task_detail_list").hide();
        $('#dlg').dialog('open');
        $('#dlg').dialog('center');
        $('#_form').form('clear');
        if($('#flowSt').combobox('getValue')==""){$('#flowSt').combobox('select',1)}
        formFocus("_form", "_name");
    }
    //打开修改窗口
    function openUpdate() {
        var selected = $("#grid").datagrid("getSelected");
    	if(!selected.canOperation){
        	$.messager.alert('提示', '项目或版本暂停中，不能删除任务');
        	return;
        }
    	
        $("#task_detail").hide();
        $("#dialog_toolbar").show();
        $("#saveTask").show();
        $("#dialog_toolbar_detail").hide();
        $("#task_detail_list").hide();

        if (null == selected) {
            $.messager.alert('警告', '请选中一条数据');
            return;
        }

        canEdit();

        if(!isCreater(selected.id)||!selected.updateDetail){
        	noEdit();
          }

        if (selected.status != "未开始") {
            noEdit();
        }

        $('#dlg').dialog('open');
        $('#dlg').dialog('center');
        formFocus("_form", "_name");
        var formData = $.extend({}, selected);
        formData = addKeyStartWith(getOriginalData(formData), "_");
        $('#_form').form('load', formData);
        $('#_form').form('load', { planTimeStr: formData._planTime });


        loadMemberSelect(formData._projectId);
        $('#_owner').combobox('select', formData._owner);
        loadVisionSelect(formData._projectId);
        $('#_versionId').combobox('select', formData._versionId);
        loadPhaseSelect(formData._versionId);
        $('#_phaseId').combobox('select', formData._phaseId);
        loadTaskSelect(formData._projectId);
        $('#_beforeTask').combobox('select', formData._beforeTask);
        $('#_form').form('load', { startDateShow: dateFormat_1(formData._startDate) });
        $('#_form').form('load', { endDateShow: dateFormat_1(formData._endDate) });
        
        if(selected.flow){ $("#changeIdTr").css("display","block");
        loadChangePorjectSelect(); 
        $('#_changeId').combobox('select',formData._changeId);
        $('#flowSt').combobox('select',0); 
       }
       else{ $("#changeIdTr").css("display","none");$('#flowSt').combobox('select',1); }
    }
    
    function copyTask(row){
        $("#task_detail").hide();
        $("#dialog_toolbar").show();
        $("#saveTask").show();
        $("#dialog_toolbar_detail").hide();
        $("#task_detail_list").hide();
    	
		var selected=$("#grid").datagrid('getData').rows[row];
		
		$('#dlg').dialog('open');
        $('#dlg').dialog('center');	
        
        var formData = $.extend({},selected);
        formData = addKeyStartWith(getOriginalData(formData),"_");
        
        canEdit();
        
        $('#_form').form('load', formData);
        $('#_form').form('load',{planTimeStr:formData._planTime});
        
        
        
        if(selected.flow){ $("#changeIdTr").css("display","block");
                            loadChangePorjectSelect(formData._projectId); 
                            $('#_changeId').combobox('select',formData._changeId);
                            $('#flowSt').combobox('select',0); 
                           }
        else{ $("#changeIdTr").css("display","none");$('#flowSt').combobox('select',1); }
        
        
        
        loadMemberSelect(formData._projectId);
        $('#_owner').combobox('select',formData._owner);

			loadVisionSelect(formData._projectId);
        $('#_versionId').combobox('select',formData._versionId);
        
        loadPhaseSelect(formData._versionId);
        $('#_phaseId').combobox('select',formData._phaseId);
        loadTaskSelect(formData._projectId);
        $('#_beforeTask').combobox('select', formData._beforeTask);
        
        
        $('#_form').form('load', {startDateShow:dateFormat_1(formData._startDate)});
        $('#_form').form('load', {endDateShow:dateFormat_1(formData._endDate)}); 
        $('#_phaseId').combobox('select',formData._phaseId);
        $('#_form').form('load', {_id:formData.id});//清除ID
    }

    function saveOrUpdate() {
        
        var logInfo = "";
		var moduleInfo="";
        $("#task_detail").hide();
        if (!$('#_form').form("validate")) {
            return;
        }

        var _formData = removeKeyStartWith($("#_form").serializeObject(), "_");
        var _url = null;
		
        //没有id就新增
        if (_formData.id == null || _formData.id == "") {
            logIngo = "新增任务:";
            moduleInfo=LOG_MODULE_OPS.ADD_PROJECT_VERSION_PHASE_TASK;
            _url = "${contextPath}/task/insert";
        } else { //有id就修改
            logIngo = "修改任务:";
            moduleInfo=LOG_MODULE_OPS.UPDATE_PROJECT_VERSION_PHASE_TASK;
            _url = "${contextPath}/task/update";
        }
     	if(isProjectDate()){
     		$.messager.alert('错误', "不符合项目开始时间和结束时间");
     		return;
     	}
        $('#dlg').dialog('close');
        $.ajax({
            type: "POST",
            url: _url,
            data: _formData,
            processData: true,
            dataType: "json",
            async: true,
            success: function(data) {
                if (data.code == "200") {
                    $("#grid").datagrid("reload");
                    LogUtils.saveLog(moduleInfo,logIngo + data.data+":成功", function() {});
                } else {
                    $.messager.alert('错误', data.result);
                }
            },
            error: function() {
                $.messager.alert('错误', '远程访问失败');
            }
        });
    }

    //根据主键删除
    function del() {
        var selected = $("#grid").datagrid("getSelected");
        
        if(!selected.canOperation){
        	$.messager.alert('提示', '项目或版本暂停中，不能删除任务');
        	return;
        }

        if(!isCreater(selected.id)){
       	 $.messager.alert('警告', '并非任务创建者,不能执行删除操作');
            return;
       }
        
        if(!selected.updateDetail){
          	 $.messager.alert('警告', '已结项,不能执行删除操作');
             return;
        }

        if (selected.status != "未开始") {
        	$.messager.alert('警告', '不是未开始的任务不能删除！');
           return ;
        }
        if (null == selected) {
            $.messager.alert('警告', '请选中一条数据');
            return;
        }
        $.messager.confirm('确认', '您确认想要删除记录吗？', function(r) {
            if (r) {
                $.ajax({
                    type: "POST",
                    url: "${contextPath}/task/delete",
                    data: { id: selected.id },
                    processData: true,
                    dataType: "json",
                    async: true,
                    success: function(data) {
                        if (data.code == "200") {
                            $("#grid").datagrid("reload");
                            $('#dlg').dialog('close');
                            LogUtils.saveLog(LOG_MODULE_OPS.DELETE_PROJECT_VERSION_PHASE_TASK,"删除任务:" + data.data+":成功", function() {});
                        } else {
                            $.messager.alert('错误', data.result);
                        }
                    },
                    error: function() {
                        $.messager.alert('错误', '远程访问失败');
                    }
                });
            }
        });

    }
    //表格查询
    function queryGrid(obj) {
    	if(obj==1){
    		$("#taskId").val(null);
    	}
        var opts = $("#grid").datagrid("options");
        if (null == opts.url || "" == opts.url) {
            opts.url = "${contextPath}/task/listTeamPage";
        }
        if (!$('#form').form("validate")) {
            return;
        }
        var param = bindMetadata("grid", true);
        var formData = $("#form").serializeObject();
        $.extend(param, formData);
        $("#grid").datagrid("load", param);
        $('#detail_form').form('load', { _taskHour: formData._planTime });
    }


    //清空表单
    function clearForm() {
        $('#form').form('clear');
        $("#owner").textbox('initValue','');
        queryGrid();
    }

    //表格表头右键菜单
    function headerContextMenu(e, field) {
        e.preventDefault();
        if (!cmenu) {
            createColumnMenu("grid");
        }
        cmenu.menu('show', {
            left: e.pageX,
            top: e.pageY
        });
    }

    $.messager.progress({
        title: "提示",
        msg: "加载中,请稍候...",
        value: '10',
        text: '{value}%',
        interval: 200
    });
    $.parser.onComplete = function() {
        $.messager.progress("close");
    }
    //全局按键事件
    function getKey(e) {
        e = e || window.event;
        var keycode = e.which ? e.which : e.keyCode;
        if (keycode == 46) { //如果按下删除键
            var selected = $("#grid").datagrid("getSelected");
            if (selected && selected != null) {
                del();
            }
        }
    }

    /**
     * 绑定页面回车事件，以及初始化页面时的光标定位
     * @formId
     *          表单ID
     * @elementName
     *          光标定位在指点表单元素的name属性的值
     * @submitFun
     *          表单提交需执行的任务
     */
    $(function() {
    <%if(project!null!=null){%>
            $('#projectId').combobox('initValue', '${project.id!}');
            $('#projectId').combobox('setText', '${project.name!}');
        <%}%>
        bindFormEvent("form", "name", queryGrid);
       // bindFormEvent("_form", "_name", saveOrUpdate, function() { $('#dlg').dialog('close'); });
        if (document.addEventListener) {
            document.addEventListener("keyup", getKey, false);
        } else if (document.attachEvent) {
            document.attachEvent("onkeyup", getKey);
        } else {
            document.onkeyup = getKey;
        }
        queryGrid();
        if (!isProjectManager()) {
            $("#manager_tools").css("display", "none");
        }
    })

    
    function formatOptions(value, row, index) {
    	if(row.updateDetail&&row.canOperation){
    		var content = '<span style="padding:5px;"><a href="javascript:void(0)" onclick="openUpdateDetail(' + index + ')">执行任务</a></span>';
    	}else{
    		var content = '<span style="padding:5px;color:#8B8B7A;text-decoration:underline;">执行任务</span>';
    	}
    	if (row.copyButton&&row.canOperation) {
    		content += '<span style="padding:5px;"><a href="javascript:void(0)" onclick="copyTask(' + index + ')">复制</a></span>';
        }
        return content;
    }
    //进度条处理
    function progressFormatter(value, rowData, rowIndex) {
        var progress = rowData.progress;
        if (rowData.progress > 100) {
            progress = 100;
        }
        var htmlstr = '<div style="width: 100px; height:20px;border: 1px solid #299a58;"><div style="width:' + progress + 'px; height:20px; background-color: #299a58;"><span>' + rowData.progress + '%</span></div></div>';
        return htmlstr;
    }

    function getDetailInfo(taskID) {

        var htmlobj = $.ajax({ url: "${contextPath}/task/listTaskDetail.json?id=" + taskID, async: false });
        var str = htmlobj.responseText;
        var obj = $.parseJSON(str);

        $('#detail_form').form('load', obj);
        $('#detail_form').form('load', { _taskHour: obj.taskHour, _overHour: obj.overHour });
    }
    
    function formatNameOptions(value, row, index) {
        var content = '<span style="padding:5px;"><a href="javascript:void(0)" onclick="openDetail(' + index + ')">'+row.name+'</a></span>';
        return content;
    }
    
    function ownerFormatter(value, row, index) {
        var content = $("#_owner").combobox('getText');
        return content;
    }
    
    function describeFormatter(value, row, index) {
    	 var content;
    	if(value==undefined){
    		content = "";
    	}else{
    		content = "<a title='"+value+"' >"+value+"</a>";
    	}
        return content;
    }
    
    function startTask() {
        $('#dlg').dialog('close');
        var id = $("#_id").val();
        $.ajax({
            type: "POST",
            url: "${contextPath}/task/updateTaskStatus?id=" + id,
            processData: true,
            dataType: "json",
            async: true,
            success: function(data) {
                if (data.code == "200") {
                    $("#grid").datagrid("reload");
                    $.messager.alert('信息', '任务开始成功');
                    LogUtils.saveLog(LOG_MODULE_OPS.START_PROJECT_VERSION_PHASE_TASK,"开始任务:" + data.data+":成功", function() {});
                } else {
                    $.messager.alert('错误', data.result);
                }
            },
            error: function() {
                $.messager.alert('错误', '远程访问失败');
            }
        });

    }


    
    function pauseTaskStatus() {
    	 $('#dlg').dialog('close');
        var id = $("#_id").val();
        $.ajax({
            type: "POST",
            url: "${contextPath}/task/pauseTaskStatus?id=" + id,
            processData: true,
            dataType: "json",
            async: true,
            success: function(data) {
                if (data.code == "200") {
                    $("#grid").datagrid("reload");
                    LogUtils.saveLog(LOG_MODULE_OPS.PAUSE_PROJECT_VERSION_PHASE_TASK,"暂停任务:" + data.data+":成功", function() {});
                } else {
                    $.messager.alert('错误', data.result);
                }
            },
            error: function() {
                $.messager.alert('错误', '远程访问失败');
            }
        });

    }
    $.extend($.fn.validatebox.defaults.rules, {
        endDateValidate: {
            validator: function(value, param) {
                var s = $("input[name=" + param[0] + "]").val();
                return value >= s;
            },
            message: '结束时间必须大于开始时间！'
        }
    });
/*     $.extend($.fn.validatebox.defaults.rules, {  
        isIds: {  
            validator: function(value){  
                return "----请选择---"!=value;  
            },  
            message: '此项为必输项'  
        }  
    });  */
</script> <script type="text/javascript">
    <#members_index />
    <#task_index />
</script> </#body>
